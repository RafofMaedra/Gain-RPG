{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>Welcome, {{ player.name }}</h2>
  <p><strong>Date:</strong> {{ today }}</p>
  <p><strong>Level:</strong> {{ player.level }}</p>
  <p><strong>Grit:</strong> {{ player.grit_current }} / {{ player.grit_max }}</p>
  <p><strong>Coins:</strong> {{ player.coins }} | <strong>Tokens:</strong> {{ player.campfire_tokens }}</p>
  <p><strong>Theme:</strong> {{ player.theme_pack }}</p>
  <p><strong>Heat:</strong> {{ player.frontier_heat }} | <strong>Tier:</strong> {{ encounter.intensity_tier if encounter.intensity_tier else intensity_preview.tier }}</p>
  <p class="hint">Tier preview base {{ intensity_preview.base }}, wobble {{ intensity_preview.wobble }}.</p>
  {% if needs_evening_nudge %}
  <p class="hint">Reminder state: minimum set not logged yet.</p>
  {% endif %}
  {% if player.testing_mode %}
  <form method="post" action="/testing/advance-day">
    <button type="submit">Testing: Advance Day + Midnight Tick</button>
  </form>
  {% endif %}
</section>

<section class="card">
  <h3>Today's Workout</h3>
  <p class="hint">Minimum set: {{ minimum_set.pushups }} pushups, {{ minimum_set.situps }} situps, {{ minimum_set.squats }} squats, {{ minimum_set.pullups }} pullup.</p>

  <form method="post" action="/workout/minimum-set">
    <button type="submit">Minimum Set</button>
  </form>

  <form method="post" action="/workout/save" class="grid-form">
    <label>Pushups <input type="number" min="0" name="pushups" value="{{ workout.pushups }}" required></label>
    <label>Situps <input type="number" min="0" name="situps" value="{{ workout.situps }}" required></label>
    <label>Squats <input type="number" min="0" name="squats" value="{{ workout.squats }}" required></label>
    <label>Pullups <input type="number" min="0" name="pullups" value="{{ workout.pullups }}" required></label>
    <button type="submit" {% if workout.locked_in_at %}disabled{% endif %}>Save Reps</button>
  </form>

  <p><strong>Grit restore preview:</strong> +{{ preview_grit }}</p>
  <p><strong>Minimum set done:</strong> {{ "Yes" if workout.minimum_set_done else "No" }}</p>
  <form method="post" action="/workout/lock-in">
    <button type="submit" {% if workout.locked_in_at %}disabled{% endif %}>Lock In Today</button>
  </form>
  {% if workout.locked_in_at %}
    <p class="hint">Locked in at {{ workout.locked_in_at }}.</p>
  {% endif %}
</section>

<section class="card">
  <h3>Campfire Tokens</h3>
  <form method="post" action="/tokens/minimum-set">
    <button type="submit">Spend 1: Treat today as minimum set</button>
  </form>
  <form method="post" action="/tokens/negate-damage">
    <button type="submit">Spend 1: Negate tonight's damage</button>
  </form>
  <form method="post" action="/tokens/reroll">
    <button type="submit">Spend 1: Reroll encounter once</button>
  </form>
</section>

<section class="card encounter-card">
  <h3>Tonight's Encounter</h3>
  <p><strong>{{ encounter.threat_name }}</strong> ({{ encounter.tag }})</p>
  <p>Tier {{ encounter.intensity_tier }} | ST {{ encounter.success_threshold }} | Damage {{ encounter.damage }} | Defeat {{ encounter.defeat_target }} / Overwhelm {{ encounter.overwhelm_target }}</p>
  <p><strong>Location:</strong> {{ encounter.location }}</p>
  <p><strong>Situation:</strong> {{ encounter.situation }}</p>
  <p><strong>Twist:</strong> {{ encounter.twist }}</p>
  {% if encounter.twist_effect %}
    <p class="twist-effect"><strong>{{ encounter.twist_effect.label }}:</strong> {{ encounter.twist_effect.description }}</p>
  {% endif %}
  {% if encounter.trait %}
    <p class="twist-effect"><strong>Boss Trait â€” {{ encounter.trait.label }}:</strong> {{ encounter.trait.description }}</p>
  {% endif %}
  <p><strong>Stakes:</strong> {{ encounter.stakes | join(', ') }}</p>

  {% if encounter_result and encounter_result.complete %}
    <div class="result-banner {{ encounter_result.outcome }}">
      <p><strong>Result:</strong> {{ encounter_result.outcome | replace('_', ' ') | title }}</p>
      <p>Grit lost: {{ encounter_result.grit_loss }}{% if encounter_result.coins_earned is defined %} | Coins earned: {{ encounter_result.coins_earned }}{% endif %}</p>
      {% if encounter_result.narrative %}
        <p class="hint">{{ encounter_result.narrative }}</p>
      {% endif %}
      <ul class="encounter-log">
        {% for line in encounter_result.log %}
          <li>{{ line }}</li>
        {% endfor %}
      </ul>
    </div>
  {% else %}
    {% if encounter_result %}
      <p><strong>In Progress:</strong> Progress {{ encounter_result.accumulated_successes }} successes | Rounds {{ encounter_result.round }}</p>
      <p>Grit spent/lost so far: {{ encounter_result.grit_loss }}</p>
    {% endif %}

    <button type="button" id="open-combat-modal">Open Combat Encounter</button>

    <form method="post" action="/encounter/auto">
      <button type="submit">Auto Resolve</button>
    </form>

    <div id="combat-modal" class="combat-modal" aria-hidden="true">
      <div class="combat-panel">
        <h4>Combat Sequence</h4>
        <p><strong id="modal-threat-name"></strong></p>
        <p class="hint" id="modal-threat-meta"></p>

        <div class="combat-stats-grid">
          <p>Progress: <strong id="ui-successes">0</strong></p>
          <p>Defeat / Overwhelm: <strong id="ui-targets">0 / 0</strong></p>
          <p>Current Grit: <strong id="ui-grit">0</strong></p>
          <p>Last Damage: <strong id="ui-damage">0</strong></p>
          <p>Barrier: <strong id="ui-barrier">0</strong></p>
        </div>

        <div class="row-actions">
          <button type="button" class="approach-btn active" data-approach="fight">Choose Approach: Fight</button>
          <button type="button" class="approach-btn" data-approach="defend">Choose Approach: Defend</button>
          <button type="button" class="approach-btn" data-approach="flee">Choose Approach: Flee</button>
        </div>

        <div class="dice-row">
          <div class="die red" id="die-red">?</div>
          <div class="die green" id="die-green">?</div>
        </div>

        <div class="push-controls">
          <div>
            <p class="hint">Red Die Push</p>
            <div class="row-actions">
              <button type="button" id="red-minus">-</button>
              <span id="red-push-value">0</span>
              <button type="button" id="red-plus">+</button>
            </div>
          </div>
          <div>
            <p class="hint">Green Die Push</p>
            <div class="row-actions">
              <button type="button" id="green-minus">-</button>
              <span id="green-push-value">0</span>
              <button type="button" id="green-plus">+</button>
            </div>
          </div>
        </div>

        <p class="hint" id="round-info">Choose approach, roll dice, adjust pushes, then Continue.</p>
        <div class="row-actions">
          <button type="button" id="roll-combat">Roll Dice</button>
          <button type="button" id="commit-round" style="display:none;">Continue</button>
          <button type="button" id="continue-after-fight" style="display:none;">Continue</button>
          <button type="button" id="close-combat-modal">Close</button>
        </div>
      </div>
    </div>
  {% endif %}
</section>

<script>
(() => {
  const modal = document.getElementById('combat-modal');
  const openBtn = document.getElementById('open-combat-modal');
  if (!modal || !openBtn) return;

  const closeBtn = document.getElementById('close-combat-modal');
  const rollBtn = document.getElementById('roll-combat');
  const commitBtn = document.getElementById('commit-round');
  const continueBtn = document.getElementById('continue-after-fight');
  const dieRed = document.getElementById('die-red');
  const dieGreen = document.getElementById('die-green');
  const info = document.getElementById('round-info');

  const redMinus = document.getElementById('red-minus');
  const redPlus = document.getElementById('red-plus');
  const greenMinus = document.getElementById('green-minus');
  const greenPlus = document.getElementById('green-plus');
  const redPushValue = document.getElementById('red-push-value');
  const greenPushValue = document.getElementById('green-push-value');

  const ui = {
    threatName: document.getElementById('modal-threat-name'),
    threatMeta: document.getElementById('modal-threat-meta'),
    successes: document.getElementById('ui-successes'),
    targets: document.getElementById('ui-targets'),
    grit: document.getElementById('ui-grit'),
    damage: document.getElementById('ui-damage'),
    barrier: document.getElementById('ui-barrier'),
  };

  let approach = 'fight';
  let preview = null;
  let pushes = { red: 0, green: 0 };

  const setApproach = (value) => {
    approach = value;
    document.querySelectorAll('.approach-btn').forEach((btn) => {
      btn.classList.toggle('active', btn.dataset.approach === value);
    });
  };

  const syncPushUi = () => {
    redPushValue.textContent = String(pushes.red);
    greenPushValue.textContent = String(pushes.green);
    redMinus.disabled = pushes.red <= 0;
    greenMinus.disabled = pushes.green <= 0;
    const maxRed = (preview?.max_pushes?.[0] || 0);
    const maxGreen = (preview?.max_pushes?.[1] || 0);
    redPlus.disabled = !preview || pushes.red >= maxRed;
    greenPlus.disabled = !preview || pushes.green >= maxGreen;
  };

  const animateDice = async () => {
    for (let i = 0; i < 8; i += 1) {
      dieRed.textContent = String(1 + Math.floor(Math.random() * 6));
      dieGreen.textContent = String(1 + Math.floor(Math.random() * 6));
      await new Promise((r) => setTimeout(r, 70));
    }
  };

  const refreshStatus = async () => {
    const response = await fetch('/api/encounter/status');
    const payload = await response.json();
    const encounter = payload.encounter || {};
    const result = payload.result || {};
    const last = result.last_round || {};
    ui.threatName.textContent = encounter.threat_name || 'Threat';
    ui.threatMeta.textContent = `ST ${encounter.success_threshold || '-'} | Defeat ${encounter.defeat_target || '-'} | Overwhelm ${encounter.overwhelm_target || '-'} | Damage Dice ${encounter.damage_dice || 1}d6`;
    ui.successes.textContent = String(result.accumulated_successes || 0);
    ui.targets.textContent = `${encounter.defeat_target || 0} / ${encounter.overwhelm_target || 0}`;
    ui.grit.textContent = `${payload.player?.grit_current ?? '-'} / ${payload.player?.grit_max ?? '-'}`;
    ui.damage.textContent = String(last.threat_damage_after_barrier || 0);
    ui.barrier.textContent = String(last.barrier_total || 0);

    if (result.complete) {
      info.textContent = `Fight ended: ${String(result.outcome || 'complete').replaceAll('_', ' ')}. Openings: ${result.openings || 0}.`;
      rollBtn.style.display = 'none';
      commitBtn.style.display = 'none';
      continueBtn.style.display = 'inline-block';
    }
  };

  redMinus.addEventListener('click', () => { pushes.red = Math.max(0, pushes.red - 1); syncPushUi(); });
  redPlus.addEventListener('click', () => { pushes.red += 1; syncPushUi(); });
  greenMinus.addEventListener('click', () => { pushes.green = Math.max(0, pushes.green - 1); syncPushUi(); });
  greenPlus.addEventListener('click', () => { pushes.green += 1; syncPushUi(); });

  document.querySelectorAll('.approach-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      setApproach(btn.dataset.approach);
      preview = null;
      pushes = { red: 0, green: 0 };
      syncPushUi();
      commitBtn.style.display = 'none';
      rollBtn.style.display = 'inline-block';
    });
  });

  rollBtn.addEventListener('click', async () => {
    rollBtn.disabled = true;
    info.textContent = 'Rolling...';
    await animateDice();

    const body = new URLSearchParams();
    body.set('action', approach);
    const response = await fetch('/api/encounter/preview', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body,
    });
    preview = await response.json();
    if (preview.complete) {
      await refreshStatus();
      rollBtn.disabled = false;
      return;
    }

    dieRed.textContent = String(preview.base_dice?.[0] ?? '?');
    dieGreen.textContent = String(preview.base_dice?.[1] ?? '?');
    pushes = { red: 0, green: 0 };
    syncPushUi();
    info.textContent = `Round ${preview.round}: base dice ${preview.base_dice}. Adjust pushes, then Continue to commit.`;
    commitBtn.style.display = 'inline-block';
    rollBtn.style.display = 'none';
    rollBtn.disabled = false;
  });

  commitBtn.addEventListener('click', async () => {
    if (!preview) return;
    commitBtn.disabled = true;
    const body = new URLSearchParams();
    body.set('action', approach);
    body.set('push_red', String(pushes.red));
    body.set('push_green', String(pushes.green));
    body.set('push_budget', String(pushes.red + pushes.green));
    body.set('tempo_bonus', '0');

    const response = await fetch('/api/encounter/step', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body,
    });
    const payload = await response.json();
    const last = payload.result?.last_round || {};
    if (Array.isArray(last.player_final_dice) && last.player_final_dice.length >= 2) {
      dieRed.textContent = String(last.player_final_dice[0]);
      dieGreen.textContent = String(last.player_final_dice[1]);
    }
    info.textContent = `Committed: ${last.successes || 0} successes. Threat rolled ${last.threat_damage_rolls || '[]'}; barrier ${last.barrier_total || 0}; damage ${last.threat_damage_after_barrier || 0}.`;
    preview = null;
    pushes = { red: 0, green: 0 };
    syncPushUi();
    commitBtn.style.display = 'none';
    rollBtn.style.display = 'inline-block';
    await refreshStatus();
    commitBtn.disabled = false;
  });

  continueBtn.addEventListener('click', () => window.location.reload());

  const openModal = async () => {
    modal.classList.add('open');
    modal.setAttribute('aria-hidden', 'false');
    setApproach('fight');
    preview = null;
    pushes = { red: 0, green: 0 };
    syncPushUi();
    commitBtn.style.display = 'none';
    rollBtn.style.display = 'inline-block';
    continueBtn.style.display = 'none';
    await refreshStatus();
  };

  const closeModal = () => {
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden', 'true');
  };

  openBtn.addEventListener('click', openModal);
  closeBtn.addEventListener('click', closeModal);
})();
</script>

<section class="card">
  <h3>Side Quest</h3>
  <p>{{ sidequest.quest.text }}</p>
  {% if sidequest.completed_at %}
    <p><strong>Completed.</strong> Progress: {{ sidequest.result.progress }} / {{ sidequest.result.needed }}</p>
  {% else %}
    <form method="post" action="/sidequest/complete" class="grid-form">
      <label>Bike minutes <input type="number" min="0" name="bike_minutes" value="0" /></label>
      <label>Kilometres <input type="number" min="0" name="km" value="0" /></label>
      <label>Mobility minutes <input type="number" min="0" name="mobility_minutes" value="0" /></label>
      <button type="submit">Attempt Side Quest</button>
    </form>
  {% endif %}
</section>
{% if player.testing_mode %}
<section class="card">
  <h3>Testing Mode Controls</h3>
  <form method="post" action="/testing/set-heat" class="row-actions">
    <input type="number" min="0" max="12" name="value" value="{{ player.frontier_heat }}" />
    <button type="submit">Set Heat</button>
  </form>
  <form method="post" action="/testing/force-roll" class="row-actions">
    <input type="text" name="for_date" value="{{ today }}" />
    <button type="submit">Force Generate Date Roll</button>
  </form>
  <form method="post" action="/testing/force-boss-today">
    <button type="submit">Force Sunday Boss Today</button>
  </form>
  <form method="post" action="/testing/reroll-free">
    <button type="submit">Reroll Encounter (Free)</button>
  </form>
</section>
{% endif %}
{% endblock %}
