{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>Welcome, {{ player.name }}</h2>
  <p><strong>Date:</strong> {{ today }}</p>
  <p><strong>Level:</strong> {{ player.level }}</p>
  <p><strong>Grit:</strong> {{ player.grit_current }} / {{ player.grit_max }}</p>
  <p><strong>Coins:</strong> {{ player.coins }} | <strong>Tokens:</strong> {{ player.campfire_tokens }}</p>
  <p><strong>Theme:</strong> {{ player.theme_pack }}</p>
  {% if needs_evening_nudge %}
  <p class="hint">Reminder state: minimum set not logged yet.</p>
  {% endif %}
  {% if player.testing_mode %}
  <form method="post" action="/testing/advance-day">
    <button type="submit">Testing: Advance Day + Midnight Tick</button>
  </form>
  {% endif %}
</section>

<section class="card">
  <h3>Today's Workout</h3>
  <p class="hint">Minimum set: {{ minimum_set.pushups }} pushups, {{ minimum_set.situps }} situps, {{ minimum_set.squats }} squats, {{ minimum_set.pullups }} pullup.</p>

  <form method="post" action="/workout/minimum-set">
    <button type="submit">Minimum Set</button>
  </form>

  <form method="post" action="/workout/save" class="grid-form">
    <label>Pushups <input type="number" min="0" name="pushups" value="{{ workout.pushups }}" required></label>
    <label>Situps <input type="number" min="0" name="situps" value="{{ workout.situps }}" required></label>
    <label>Squats <input type="number" min="0" name="squats" value="{{ workout.squats }}" required></label>
    <label>Pullups <input type="number" min="0" name="pullups" value="{{ workout.pullups }}" required></label>
    <button type="submit" {% if workout.locked_in_at %}disabled{% endif %}>Save Reps</button>
  </form>

  <p><strong>Grit restore preview:</strong> +{{ preview_grit }}</p>
  <p><strong>Minimum set done:</strong> {{ "Yes" if workout.minimum_set_done else "No" }}</p>
  <form method="post" action="/workout/lock-in">
    <button type="submit" {% if workout.locked_in_at %}disabled{% endif %}>Lock In Today</button>
  </form>
  {% if workout.locked_in_at %}
    <p class="hint">Locked in at {{ workout.locked_in_at }}.</p>
  {% endif %}
</section>

<section class="card">
  <h3>Campfire Tokens</h3>
  <form method="post" action="/tokens/minimum-set">
    <button type="submit">Spend 1: Treat today as minimum set</button>
  </form>
  <form method="post" action="/tokens/negate-damage">
    <button type="submit">Spend 1: Negate tonight's damage</button>
  </form>
  <form method="post" action="/tokens/reroll">
    <button type="submit">Spend 1: Reroll encounter once</button>
  </form>
</section>

<section class="card">
  <h3>Tonight's Encounter</h3>
  <p><strong>{{ encounter.threat_name }}</strong> ({{ encounter.tag }})</p>
  <p>HP {{ encounter.hp }} | Damage {{ encounter.damage }}</p>

  {% if encounter_result and encounter_result.complete %}
    <p><strong>Result:</strong> {{ encounter_result.outcome }}</p>
    <p>Grit lost: {{ encounter_result.grit_loss }}{% if encounter_result.coins_earned is defined %} | Coins earned: {{ encounter_result.coins_earned }}{% endif %}</p>
    {% if encounter_result.narrative %}
    <p class="hint">{{ encounter_result.narrative }}</p>
    {% endif %}
    <ul>
      {% for line in encounter_result.log %}
      <li>{{ line }}</li>
      {% endfor %}
    </ul>
  {% else %}
    {% if encounter_result %}
      <p><strong>In Progress:</strong> Threat HP {{ encounter_result.threat_hp }} | Rounds {{ encounter_result.round }}</p>
      <p>Grit lost so far: {{ encounter_result.grit_loss }}</p>
    {% endif %}

    <form method="post" action="/encounter/auto">
      <button type="submit">Auto Resolve</button>
    </form>
    <form method="post" action="/encounter/manual" class="row-actions">
      <button type="submit" name="action" value="strike">Strike</button>
      <button type="submit" name="action" value="guard">Guard</button>
    </form>
    {% if player.testing_mode %}
    <form method="post" action="/encounter/refresh">
      <button type="submit">Testing: Refresh Encounter</button>
    </form>
    {% endif %}
  {% endif %}
</section>

<section class="card">
  <h3>Side Quest</h3>
  <p>{{ sidequest.quest.text }}</p>
  {% if sidequest.completed_at %}
    <p><strong>Completed.</strong> Progress: {{ sidequest.result.progress }} / {{ sidequest.result.needed }}</p>
  {% else %}
    <form method="post" action="/sidequest/complete" class="grid-form">
      <label>Bike minutes <input type="number" min="0" name="bike_minutes" value="0" /></label>
      <label>Kilometres <input type="number" min="0" name="km" value="0" /></label>
      <label>Mobility minutes <input type="number" min="0" name="mobility_minutes" value="0" /></label>
      <button type="submit">Attempt Side Quest</button>
    </form>
  {% endif %}
</section>
{% endblock %}
