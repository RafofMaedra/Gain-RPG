{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>Welcome, {{ player.name }}</h2>
  <p><strong>Date:</strong> {{ today }}</p>
  <p><strong>Level:</strong> {{ player.level }}</p>
  <p><strong>Grit:</strong> {{ player.grit_current }} / {{ player.grit_max }}</p>
  <p><strong>Coins:</strong> {{ player.coins }} | <strong>Tokens:</strong> {{ player.campfire_tokens }}</p>
  <p><strong>Theme:</strong> {{ player.theme_pack }}</p>
  <p><strong>Heat:</strong> {{ player.frontier_heat }} | <strong>Tier:</strong> {{ encounter.intensity_tier if encounter.intensity_tier else intensity_preview.tier }}</p>
  <p class="hint">Tier preview base {{ intensity_preview.base }}, wobble {{ intensity_preview.wobble }}.</p>
  {% if needs_evening_nudge %}
  <p class="hint">Reminder state: minimum set not logged yet.</p>
  {% endif %}
  {% if player.testing_mode %}
  <form method="post" action="/testing/advance-day">
    <button type="submit">Testing: Advance Day + Midnight Tick</button>
  </form>
  {% endif %}
</section>

<section class="card">
  <h3>Today's Workout</h3>
  <p class="hint">Minimum set: {{ minimum_set.pushups }} pushups, {{ minimum_set.situps }} situps, {{ minimum_set.squats }} squats, {{ minimum_set.pullups }} pullup.</p>

  <form method="post" action="/workout/minimum-set">
    <button type="submit">Minimum Set</button>
  </form>

  <form method="post" action="/workout/save" class="grid-form">
    <label>Pushups <input type="number" min="0" name="pushups" value="{{ workout.pushups }}" required></label>
    <label>Situps <input type="number" min="0" name="situps" value="{{ workout.situps }}" required></label>
    <label>Squats <input type="number" min="0" name="squats" value="{{ workout.squats }}" required></label>
    <label>Pullups <input type="number" min="0" name="pullups" value="{{ workout.pullups }}" required></label>
    <button type="submit" {% if workout.locked_in_at %}disabled{% endif %}>Save Reps</button>
  </form>

  <p><strong>Grit restore preview:</strong> +{{ preview_grit }}</p>
  <p><strong>Minimum set done:</strong> {{ "Yes" if workout.minimum_set_done else "No" }}</p>
  <form method="post" action="/workout/lock-in">
    <button type="submit" {% if workout.locked_in_at %}disabled{% endif %}>Lock In Today</button>
  </form>
  {% if workout.locked_in_at %}
    <p class="hint">Locked in at {{ workout.locked_in_at }}.</p>
  {% endif %}
</section>

<section class="card">
  <h3>Campfire Tokens</h3>
  <form method="post" action="/tokens/minimum-set">
    <button type="submit">Spend 1: Treat today as minimum set</button>
  </form>
  <form method="post" action="/tokens/negate-damage">
    <button type="submit">Spend 1: Negate tonight's damage</button>
  </form>
  <form method="post" action="/tokens/reroll">
    <button type="submit">Spend 1: Reroll encounter once</button>
  </form>
</section>

<section class="card encounter-card">
  <h3>Tonight's Encounter</h3>
  <p><strong>{{ encounter.threat_name }}</strong> ({{ encounter.tag }})</p>
  <p>Tier {{ encounter.intensity_tier }} | ST {{ encounter.success_threshold }} | Damage {{ encounter.damage }} | Defeat {{ encounter.defeat_target }} / Overwhelm {{ encounter.overwhelm_target }}</p>
  <p><strong>Location:</strong> {{ encounter.location }}</p>
  <p><strong>Situation:</strong> {{ encounter.situation }}</p>
  <p><strong>Twist:</strong> {{ encounter.twist }}</p>
  {% if encounter.twist_effect %}
    <p class="twist-effect"><strong>{{ encounter.twist_effect.label }}:</strong> {{ encounter.twist_effect.description }}</p>
  {% endif %}
  {% if encounter.trait %}
    <p class="twist-effect"><strong>Boss Trait — {{ encounter.trait.label }}:</strong> {{ encounter.trait.description }}</p>
  {% endif %}
  <p><strong>Stakes:</strong> {{ encounter.stakes | join(', ') }}</p>

  {% if encounter_result and encounter_result.complete %}
    <div class="result-banner {{ encounter_result.outcome }}">
      <p><strong>Result:</strong> {{ encounter_result.outcome | replace('_', ' ') | title }}</p>
      <p>Grit lost: {{ encounter_result.grit_loss }}{% if encounter_result.coins_earned is defined %} | Coins earned: {{ encounter_result.coins_earned }}{% endif %}</p>
      {% if encounter_result.narrative %}
        <p class="hint">{{ encounter_result.narrative }}</p>
      {% endif %}
      <ul class="encounter-log">
        {% for line in encounter_result.log %}
          <li>{{ line }}</li>
        {% endfor %}
      </ul>
    </div>
  {% else %}
    {% if encounter_result %}
      <p><strong>In Progress:</strong> Progress {{ encounter_result.accumulated_successes }} successes | Rounds {{ encounter_result.round }}</p>
      <p>Grit spent/lost so far: {{ encounter_result.grit_loss }}</p>
    {% endif %}

    <button type="button" id="open-combat-modal">Open Combat Encounter</button>

    <form method="post" action="/encounter/auto">
      <button type="submit">Auto Resolve</button>
    </form>

    <div id="combat-modal" class="combat-modal" aria-hidden="true">
      <div class="combat-panel">
        <h4>Combat Sequence</h4>
        <p>Hit the shown sequence in order to gain momentum for your next action.</p>
        <p id="combo-sequence" class="combo"></p>
        <p id="combo-feedback" class="hint"></p>
        <div class="row-actions">
          <button type="button" class="combo-btn" data-move="strike">Strike</button>
          <button type="button" class="combo-btn" data-move="guard">Guard</button>
        </div>

        <form method="post" action="/encounter/manual" class="grid-form">
          <input type="hidden" name="tempo_bonus" id="tempo-bonus" value="0" />
          <label>Push Grit (0-6)
            <input type="number" min="0" max="6" name="push_budget" value="0" />
          </label>
          <div class="row-actions">
            <button type="submit" name="action" value="strike">Commit Strike</button>
            <button type="submit" name="action" value="guard">Commit Guard</button>
            <button type="submit" name="action" value="flee">Attempt Flee</button>
          </div>
        </form>
        <button type="button" id="close-combat-modal">Close</button>
      </div>
    </div>
  {% endif %}
</section>

<script>
(() => {
  const modal = document.getElementById('combat-modal');
  const openBtn = document.getElementById('open-combat-modal');
  if (!modal || !openBtn) return;

  const sequenceEl = document.getElementById('combo-sequence');
  const feedbackEl = document.getElementById('combo-feedback');
  const tempoInput = document.getElementById('tempo-bonus');
  const closeBtn = document.getElementById('close-combat-modal');
  const buttons = Array.from(document.querySelectorAll('.combo-btn'));

  let pattern = [];
  let index = 0;

  const generatePattern = () => {
    pattern = Array.from({length: 3}, () => Math.random() > 0.5 ? 'strike' : 'guard');
    index = 0;
    sequenceEl.textContent = 'Pattern: ' + pattern.join(' → ');
    feedbackEl.textContent = 'Ready.';
    tempoInput.value = '0';
  };

  const openModal = () => {
    modal.classList.add('open');
    modal.setAttribute('aria-hidden', 'false');
    generatePattern();
  };

  const closeModal = () => {
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden', 'true');
  };

  openBtn.addEventListener('click', openModal);
  closeBtn.addEventListener('click', closeModal);

  buttons.forEach((btn) => {
    btn.addEventListener('click', () => {
      const move = btn.dataset.move;
      if (move === pattern[index]) {
        index += 1;
        feedbackEl.textContent = `Step ${index}/3 correct.`;
      } else {
        index = 0;
        feedbackEl.textContent = 'Miss! sequence reset.';
      }

      if (index >= pattern.length) {
        tempoInput.value = '2';
        feedbackEl.textContent = 'Perfect combo! +2 momentum on your commit action.';
      } else if (index === 2) {
        tempoInput.value = '1';
      }
    });
  });
})();
</script>

<section class="card">
  <h3>Side Quest</h3>
  <p>{{ sidequest.quest.text }}</p>
  {% if sidequest.completed_at %}
    <p><strong>Completed.</strong> Progress: {{ sidequest.result.progress }} / {{ sidequest.result.needed }}</p>
  {% else %}
    <form method="post" action="/sidequest/complete" class="grid-form">
      <label>Bike minutes <input type="number" min="0" name="bike_minutes" value="0" /></label>
      <label>Kilometres <input type="number" min="0" name="km" value="0" /></label>
      <label>Mobility minutes <input type="number" min="0" name="mobility_minutes" value="0" /></label>
      <button type="submit">Attempt Side Quest</button>
    </form>
  {% endif %}
</section>
{% if player.testing_mode %}
<section class="card">
  <h3>Testing Mode Controls</h3>
  <form method="post" action="/testing/set-heat" class="row-actions">
    <input type="number" min="0" max="12" name="value" value="{{ player.frontier_heat }}" />
    <button type="submit">Set Heat</button>
  </form>
  <form method="post" action="/testing/force-roll" class="row-actions">
    <input type="text" name="for_date" value="{{ today }}" />
    <button type="submit">Force Generate Date Roll</button>
  </form>
  <form method="post" action="/testing/force-boss-today">
    <button type="submit">Force Sunday Boss Today</button>
  </form>
  <form method="post" action="/testing/reroll-free">
    <button type="submit">Reroll Encounter (Free)</button>
  </form>
</section>
{% endif %}
{% endblock %}
